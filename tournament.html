<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leaderboard</title>
    <style>
        :root {
          --squabbit-green: #2e9141;
        }
        body {
          font-family: Arial, sans-serif;
          margin: 0;
          padding: 20px;
          background-color: #f5f5f5;
          color: #333;
        }
        h1 {
          text-align: center;
          margin-bottom: 4px;
        }
        #tournamentDate {
          text-align: center;
          font-size: 14px;
          color: #666;
          margin-bottom: 20px;
        }

        #formatChipsContainer {
          display: flex;
          gap: 10px;
          flex-wrap: wrap;
          justify-content: flex-start;
          margin-bottom: 20px;
        }

        .format-chip {
          padding: 8px 16px;
          border-radius: 20px;
          background-color: #e0e0e0;
          color: #333;
          font-weight: 500;
          cursor: pointer;
          border: none;
          outline: none;
          transition: background-color 0.2s, color 0.2s;
        }

        .format-chip.active {
          background-color: var(--squabbit-green);
          color: white;
        }

        table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 10px;
          background-color: white;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        th, td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
          vertical-align: top;
          white-space: nowrap;
        }

        td.name-column {
          width: 100%;
        }

        .subtext {
          font-size: 0.8em;
          color: #666;
        }

        .loading-spinner {
          text-align: center;
          margin: 50px;
        }

        .loading-spinner::after {
          content: "";
          display: inline-block;
          width: 24px;
          height: 24px;
          border: 4px solid var(--squabbit-green);
          border-top-color: transparent;
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        .app-prompt {
          margin-top: 50px;
          text-align: center;
        }

        .app-prompt a {
          display: inline-block;
          text-decoration: none;
          color: inherit;
        }

        .app-prompt img {
          width: 72px;
          height: 72px;
        }

        .powered-by {
          font-size: 10px;
          font-weight: normal;
          color: #555;
          margin-top: 8px;
        }

        .squabbit-name {
          font-size: 22px;
          font-weight: bold;
          color: var(--squabbit-green);
        }

        .see-more {
          display: inline-block;
          margin-top: 12px;
          background-color: var(--squabbit-green);
          color: white;
          font-size: 16px;
          font-weight: 500;
          padding: 10px 20px;
          border-radius: 24px;
          text-decoration: none;
          transition: background-color 0.2s;
        }

        .see-more:hover {
          background-color: #247634;
        }
    </style>
</head>
<body>
<h1 id="title">Leaderboard</h1>
<div id="tournamentDate"></div>

<div id="formatChipsContainer"></div>

<div id="loadingSpinner" class="loading-spinner"></div>
<div id="leaderboard-container"></div>

<div id="appPrompt" class="app-prompt" style="display: none">
    <a id="appLink" href="#">
        <img src="assets/icon_transparent.png" alt="Squabbit logo">
        <div class="powered-by">Powered by</div>
        <div class="squabbit-name">Squabbit</div>
        <div><span class="see-more">See more in the app</span></div>
    </a>
</div>

<script>
    let allLeaderboards = {};
    let numTournamentRounds = 0;
    let inviteCode = "";

    async function loadLeaderboard() {
      const params = new URLSearchParams(window.location.search);
      const tournamentId = params.get("id");

      if (!tournamentId) {
        document.getElementById("leaderboard-container").innerHTML =
          "<p>No tournament ID provided.</p>";
        document.getElementById("loadingSpinner").style.display = "none";
        return;
      }

      try {
        const res = await fetch(
          `https://us-central1-squabbit-2019.cloudfunctions.net/publicLeaderboard?tournamentId=${tournamentId}`
        );
        const data = await res.json();

        const leaderboards = data.leaderboards;
        numTournamentRounds = data.numTournamentRounds || 0;
        inviteCode = data.inviteCode || "";

        if (!leaderboards || Object.keys(leaderboards).length === 0) {
          document.getElementById("leaderboard-container").innerHTML =
            "<p>No leaderboard data found.</p>";
          document.getElementById("loadingSpinner").style.display = "none";
          return;
        }

        if (data.tournamentName) {
          document.getElementById("title").textContent = data.tournamentName;
        }

        if (data.date && data.date._seconds) {
          const date = new Date(data.date._seconds * 1000);
          const options = { year: 'numeric', month: 'long', day: 'numeric' };
          document.getElementById("tournamentDate").textContent = date.toLocaleDateString(undefined, options);
        }

        if (inviteCode) {
          document.getElementById("appPrompt").style.display = "block";
          document.getElementById("appLink").href = `https://app.squabbitgolf.com/tournament?inviteCode=${inviteCode}`;
        }

        allLeaderboards = leaderboards;
        renderFormatChips(leaderboards);
        document.getElementById("loadingSpinner").style.display = "none";
      } catch (error) {
        console.error("Failed to load leaderboard:", error);
        document.getElementById("leaderboard-container").innerHTML =
          "<p>Failed to load leaderboard data.</p>";
        document.getElementById("loadingSpinner").style.display = "none";
      }
    }

    function renderFormatChips(leaderboards) {
      const container = document.getElementById("formatChipsContainer");
      container.innerHTML = "";

      const keys = Object.keys(leaderboards);

      keys.forEach((key, index) => {
        const chip = document.createElement("button");
        chip.className = "format-chip";
        chip.textContent = leaderboards[key].formatName || `Format ${index + 1}`;
        chip.dataset.formatKey = key;

        chip.addEventListener("click", () => {
          document.querySelectorAll(".format-chip").forEach(c => c.classList.remove("active"));
          chip.classList.add("active");
          renderFormat(key);
        });

        container.appendChild(chip);
      });

      // Auto-select first format
      const firstKey = keys[0];
      container.querySelector(`[data-format-key="${firstKey}"]`).classList.add("active");
      renderFormat(firstKey);
    }

    function renderFormat(formatKey) {
      const container = document.getElementById("leaderboard-container");
      container.innerHTML = "";

      const format = allLeaderboards[formatKey];
      if (!format) return;

      const table = document.createElement("table");
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      ["Place", "Name"].forEach((text) => {
        const th = document.createElement("th");
        th.textContent = text;
        if (text === "Name") th.classList.add("name-column");
        headerRow.appendChild(th);
      });

      for (let r = 1; r <= numTournamentRounds; r++) {
        const th = document.createElement("th");
        th.textContent = `R${r}`;
        headerRow.appendChild(th);
      }

      const totalTh = document.createElement("th");
      totalTh.textContent = "Total";
      headerRow.appendChild(totalTh);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      const entries = format.teamEntries && format.teamEntries.length > 0
        ? format.teamEntries
        : format.userEntries || [];

      const withPlace = entries.filter((e) => e.place != null);
      const withoutPlace = entries.filter((e) => e.place == null);
      withPlace.sort((a, b) => a.place - b.place);
      const combined = [...withPlace, ...withoutPlace];

      combined.forEach((entry) => {
        const row = document.createElement("tr");
        const place = entry.place != null
          ? (entry.isTied ? `T${entry.place}` : `${entry.place}`)
          : "-";
        const name = entry.entityName || "-";

        row.innerHTML = `<td>${place}</td><td class="name-column">${name}</td>`;

        const roundResults = entry.tournamentRoundResults || [];

        for (let r = 1; r <= numTournamentRounds; r++) {
          const td = document.createElement("td");
          const round = roundResults.find((rr) => rr.roundNumber === r);
          if (round && round.totalDisplayString) {
            const match = round.totalDisplayString.match(/(.+?)( thru \d+)?$/);
            const mainText = match[1];
            const subText = match[2] || "";
            td.innerHTML = `${mainText}${subText ? `<div class='subtext'>${subText.trim()}</div>` : ""}`;
          } else {
            td.textContent = "-";
          }
          row.appendChild(td);
        }

        const score = entry.totalDisplayString != null ? entry.totalDisplayString : "-";
        const totalTd = document.createElement("td");
        totalTd.textContent = score;
        row.appendChild(totalTd);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }

    window.addEventListener("DOMContentLoaded", loadLeaderboard);
</script>
</body>
</html>
